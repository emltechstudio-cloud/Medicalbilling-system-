<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medical Billing System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 400px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      padding: 20px 0;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    .option-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      margin-bottom: 15px;
    }

    .option-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(0,0,0,0.15);
      border-color: #667eea;
    }

    .option-card .icon {
      font-size: 30px;
      margin-bottom: 10px;
      text-align: center;
    }

    .option-card h3 {
      font-size: 18px;
      margin-bottom: 5px;
      color: #333;
    }

    .option-card p {
      font-size: 14px;
      color: #666;
      line-height: 1.4;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group select {
      background-color: white;
      cursor: pointer;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5a6fd8;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      width: 40px;
      height: 40px;
    }

    .claims-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .claim-item {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .claim-info h4 {
      margin-bottom: 5px;
      color: #333;
    }

    .claim-info p {
      font-size: 12px;
      color: #666;
    }

    .claim-actions {
      display: flex;
      gap: 5px;
    }

    .claim-actions button {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    .view-btn {
      background: #007bff;
      color: white;
    }

    .delete-btn {
      background: #dc3545;
      color: white;
    }

    .notes-options {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .notes-tab {
      flex: 1;
      padding: 12px;
      background: #e9ecef;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .notes-tab.active {
      background: #667eea;
      color: white;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px;
      text-align: center;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .claim-output {
      background: #f8f9fa;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      padding: 15px;
      min-height: 200px;
      font-family: monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      width: 100%;
      resize: vertical;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .action-buttons .btn {
      flex: 1;
      margin-top: 0;
    }

    .hidden {
      display: none !important;
    }

    .metadata-summary {
      background: #e3f2fd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .metadata-summary h4 {
      margin-bottom: 10px;
      color: #333;
    }

    .metadata-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .recording-interface {
      text-align: center;
      padding: 20px;
    }

    .record-btn {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: none;
      background: #dc3545;
      color: white;
      font-size: 24px;
      margin: 20px auto;
      display: block;
      cursor: pointer;
      transition: all 0.3s;
    }

    .record-btn.recording {
      background: #28a745;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .recording-time {
      font-size: 24px;
      color: #28a745;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="back-btn hidden" id="backBtn" onclick="goBack()">‚Üê</button>
    
    <div class="header">
      <h1>Medical Billing System</h1>
      <p id="headerSubtitle">Professional Medical Claims Management</p>
    </div>

    <!-- HOME SCREEN -->
    <div id="homeScreen" class="screen active">
      <div class="option-card" onclick="showScreen('claimsScreen')">
        <div class="icon">üìã</div>
        <h3>View Claims</h3>
        <p>Review and manage saved medical claims</p>
      </div>
      
      <div class="option-card" onclick="showScreen('newClaimScreen')">
        <div class="icon">‚ûï</div>
        <h3>Generate New Claim</h3>
        <p>Create a new medical billing claim</p>
      </div>
    </div>

    <!-- CLAIMS HISTORY SCREEN -->
    <div id="claimsScreen" class="screen">
      <div class="card">
        <h2 style="margin-bottom: 20px; color: #333;">Saved Claims</h2>
        <div class="claims-list" id="claimsList">
          <!-- Claims will be populated here -->
        </div>
        <div id="noClaimsMessage" class="text-center" style="color: #666; padding: 20px;">
          No saved claims yet. Generate your first claim!
        </div>
      </div>
    </div>

    <!-- NEW CLAIM FORM SCREEN -->
    <div id="newClaimScreen" class="screen">
      <div class="card">
        <h2 style="margin-bottom: 20px; color: #333;">Patient Information</h2>
        
        <form id="patientForm">
          <div class="form-group">
            <label>Patient Name *</label>
            <input type="text" id="patientName" required>
          </div>
          
          <div class="form-group">
            <label>Age *</label>
            <input type="number" id="age" required>
          </div>
          
          <div class="form-group">
            <label>Sex *</label>
            <select id="sex" required>
              <option value="">Select...</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Insurance Provider *</label>
            <input type="text" id="insuranceProvider" required>
          </div>
          
          <div class="form-group">
            <label>Policy Number *</label>
            <input type="text" id="policyNumber" required>
          </div>
          
          <div class="form-group">
            <label>Encounter Type *</label>
            <select id="encounterType" required>
              <option value="">Select encounter type...</option>
              <option value="office-visit">Office Visit</option>
              <option value="nurse-office">Nurse's Office</option>
              <option value="x-ray">X-Ray</option>
              <option value="laboratory">Laboratory</option>
              <option value="consultation">Consultation</option>
              <option value="emergency">Emergency Visit</option>
              <option value="follow-up">Follow-up</option>
              <option value="physical-exam">Physical Examination</option>
              <option value="procedure">Medical Procedure</option>
              <option value="telehealth">Telehealth</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Healthcare Provider *</label>
            <input type="text" id="healthcareProvider" placeholder="Provider name/account number..." required>
          </div>
          
          <button type="submit" class="btn btn-primary">Continue to Medical Notes</button>
        </form>
      </div>
    </div>

    <!-- MEDICAL NOTES SCREEN -->
    <div id="notesScreen" class="screen">
      <div class="card">
        <h2 style="margin-bottom: 20px; color: #333;">Medical Notes</h2>
        
        <div class="metadata-summary" id="patientSummary">
          <!-- Patient info summary will appear here -->
        </div>
        
        <div class="notes-options">
          <button class="notes-tab active" id="typeTab" onclick="switchNotesMode('type')">‚úçÔ∏è Type Notes</button>
          <button class="notes-tab" id="recordTab" onclick="switchNotesMode('record')">üé§ Record Audio</button>
        </div>
        
        <!-- Type Notes Mode -->
        <div id="typeNotesMode">
          <div class="form-group">
            <label>Medical History / Notes</label>
            <textarea id="medicalNotes" rows="8" placeholder="Enter symptoms, diagnosis, treatment notes, observations..."></textarea>
          </div>
          <button class="btn btn-primary" onclick="showReviewScreen()">Review & Generate Claim</button>
        </div>
        
        <!-- Record Audio Mode -->
        <div id="recordNotesMode" class="hidden">
          <div class="recording-interface">
            <p>Use your phone's native recorder app, then transcribe here:</p>
            <div class="form-group">
              <label>Transcribed Notes</label>
              <textarea id="transcribedNotes" rows="8" placeholder="Paste or type transcribed notes here..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="showReviewScreen()">Review & Generate Claim</button>
          </div>
        </div>
      </div>
    </div>

    <!-- REVIEW & GENERATE SCREEN -->
    <div id="reviewScreen" class="screen">
      <div class="card">
        <h2 style="margin-bottom: 20px; color: #333;">Review Information</h2>
        
        <div id="fullPatientSummary" class="metadata-summary">
          <!-- Complete patient info will appear here -->
        </div>
        
        <div class="form-group">
          <label>Medical Notes (Editable)</label>
          <textarea id="finalNotes" rows="6"></textarea>
        </div>
        
        <button class="btn btn-success" onclick="generateFinalClaim()">üî• Generate Claim</button>
      </div>
      
      <!-- Generated Claim -->
      <div class="card hidden" id="generatedClaimCard">
        <h2 style="margin-bottom: 15px; color: #333;">Generated Medical Claim</h2>
        <div id="loadingDiv" class="loading hidden">
          <div class="spinner"></div>
          <p>Generating claim with CPT/ICD codes...</p>
        </div>
        <textarea class="claim-output hidden" id="claimOutput"></textarea>
        <div class="action-buttons hidden" id="claimActions">
          <button class="btn btn-success" onclick="saveClaim()">üíæ Save</button>
          <button class="btn btn-primary" onclick="shareClaim()">üì§ Share</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://emmanuel154-medical-billing-system24-7.hf.space";
    let currentPatientData = {};
    let currentScreen = 'homeScreen';
    let screenStack = [];

    // Initialize app
    loadSavedClaims();

    function showScreen(screenId, addToStack = true) {
      // Hide all screens
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      
      // Show target screen
      document.getElementById(screenId).classList.add('active');
      
      // Update header
      updateHeader(screenId);
      
      // Manage back button and screen stack
      if (addToStack) {
        screenStack.push(currentScreen);
      }
      currentScreen = screenId;
      
      // Show/hide back button
      const backBtn = document.getElementById('backBtn');
      if (screenId === 'homeScreen') {
        backBtn.classList.add('hidden');
        screenStack = [];
      } else {
        backBtn.classList.remove('hidden');
      }
    }

    function goBack() {
      if (screenStack.length > 0) {
        const previousScreen = screenStack.pop();
        showScreen(previousScreen, false);
      }
    }

    function updateHeader(screenId) {
      const subtitle = document.getElementById('headerSubtitle');
      switch(screenId) {
        case 'homeScreen':
          subtitle.textContent = 'Professional Medical Claims Management';
          break;
        case 'claimsScreen':
          subtitle.textContent = 'Saved Claims History';
          break;
        case 'newClaimScreen':
          subtitle.textContent = 'New Claim - Patient Info';
          break;
        case 'notesScreen':
          subtitle.textContent = 'Medical Notes';
          break;
        case 'reviewScreen':
          subtitle.textContent = 'Review & Generate';
          break;
      }
    }

    // Handle patient form submission
    document.getElementById('patientForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      currentPatientData = {
        patient_name: document.getElementById('patientName').value,
        age: parseInt(document.getElementById('age').value),
        sex: document.getElementById('sex').value,
        insurance_provider: document.getElementById('insuranceProvider').value,
        policy_number: document.getElementById('policyNumber').value,
        encounter_type: document.getElementById('encounterType').value,
        healthcare_provider: document.getElementById('healthcareProvider').value
      };
      
      showPatientSummary();
      showScreen('notesScreen');
    });

    function showPatientSummary() {
      const summary = `
        <h4>Patient Summary:</h4>
        <div class="metadata-row"><span><strong>Name:</strong></span><span>${currentPatientData.patient_name}</span></div>
        <div class="metadata-row"><span><strong>Age:</strong></span><span>${currentPatientData.age}</span></div>
        <div class="metadata-row"><span><strong>Insurance:</strong></span><span>${currentPatientData.insurance_provider}</span></div>
        <div class="metadata-row"><span><strong>Encounter:</strong></span><span>${currentPatientData.encounter_type}</span></div>
        <div class="metadata-row"><span><strong>Provider:</strong></span><span>${currentPatientData.healthcare_provider}</span></div>
      `;
      document.getElementById('patientSummary').innerHTML = summary;
    }

    function switchNotesMode(mode) {
      // Update tabs
      document.getElementById('typeTab').classList.toggle('active', mode === 'type');
      document.getElementById('recordTab').classList.toggle('active', mode === 'record');
      
      // Show/hide modes
      document.getElementById('typeNotesMode').classList.toggle('hidden', mode !== 'type');
      document.getElementById('recordNotesMode').classList.toggle('hidden', mode !== 'record');
    }

    function showReviewScreen() {
      // Get notes from active mode
      const medicalNotes = document.getElementById('medicalNotes').value || 
                          document.getElementById('transcribedNotes').value;
      
      if (!medicalNotes.trim()) {
        alert('Please enter medical notes before continuing');
        return;
      }
      
      currentPatientData.medical_history = medicalNotes;
      
      // Show complete summary
      const fullSummary = `
        <h4>Complete Patient Information:</h4>
        <div class="metadata-row"><span><strong>Name:</strong></span><span>${currentPatientData.patient_name}</span></div>
        <div class="metadata-row"><span><strong>Age:</strong></span><span>${currentPatientData.age}</span></div>
        <div class="metadata-row"><span><strong>Sex:</strong></span><span>${currentPatientData.sex}</span></div>
        <div class="metadata-row"><span><strong>Insurance:</strong></span><span>${currentPatientData.insurance_provider}</span></div>
        <div class="metadata-row"><span><strong>Policy:</strong></span><span>${currentPatientData.policy_number}</span></div>
        <div class="metadata-row"><span><strong>Encounter:</strong></span><span>${currentPatientData.encounter_type}</span></div>
        <div class="metadata-row"><span><strong>Provider:</strong></span><span>${currentPatientData.healthcare_provider}</span></div>
      `;
      document.getElementById('fullPatientSummary').innerHTML = fullSummary;
      document.getElementById('finalNotes').value = medicalNotes;
      
      showScreen('reviewScreen');
    }

    async function generateFinalClaim() {
      // Update notes if edited
      currentPatientData.medical_history = document.getElementById('finalNotes').value;
      
      // Show loading
      document.getElementById('generatedClaimCard').classList.remove('hidden');
      document.getElementById('loadingDiv').classList.remove('hidden');
      document.getElementById('claimOutput').classList.add('hidden');
      document.getElementById('claimActions').classList.add('hidden');
      
      const payload = {
        metadata: currentPatientData,
        text: currentPatientData.medical_history
      };
      
      try {
        const response = await fetch(`${API_BASE}/submit_text`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        document.getElementById('loadingDiv').classList.add('hidden');
        
        if (data.claim_text) {
          document.getElementById('claimOutput').classList.remove('hidden');
          document.getElementById('claimOutput').value = data.claim_text;
          document.getElementById('claimActions').classList.remove('hidden');
        } else {
          throw new Error(data.detail || 'Claim generation failed');
        }
      } catch (error) {
        document.getElementById('loadingDiv').classList.add('hidden');
        alert('Error generating claim: ' + error.message);
      }
    }

    function saveClaim() {
      const claimText = document.getElementById('claimOutput').value;
      const fileName = `Claim_${currentPatientData.patient_name}_${new Date().toISOString().slice(0,19)}.txt`;
      
      // Save to localStorage for claims history
      const savedClaims = JSON.parse(localStorage.getItem('savedClaims') || '[]');
      const newClaim = {
        id: Date.now(),
        patientName: currentPatientData.patient_name,
        date: new Date().toLocaleDateString(),
        encounter: currentPatientData.encounter_type,
        claimText: claimText,
        fileName: fileName
      };
      savedClaims.unshift(newClaim);
      localStorage.setItem('savedClaims', JSON.stringify(savedClaims));
      
      // Download file
      const blob = new Blob([claimText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(url);
      
      alert('Claim saved successfully!');
      loadSavedClaims();
    }

    function shareClaim() {
      const claimText = document.getElementById('claimOutput').value;
      
      if (navigator.share) {
        navigator.share({
          title: `Medical Claim - ${currentPatientData.patient_name}`,
          text: claimText
        });
      } else {
        navigator.clipboard.writeText(claimText).then(() => {
          alert('Claim copied to clipboard!');
        });
      }
    }

    function loadSavedClaims() {
      const savedClaims = JSON.parse(localStorage.getItem('savedClaims') || '[]');
      const claimsList = document.getElementById('claimsList');
      const noClaimsMessage = document.getElementById('noClaimsMessage');
      
      if (savedClaims.length === 0) {
        claimsList.style.display = 'none';
        noClaimsMessage.style.display = 'block';
      } else {
        claimsList.style.display = 'block';
        noClaimsMessage.style.display = 'none';
        
        claimsList.innerHTML = savedClaims.map(claim => `
          <div class="claim-item">
            <div class="claim-info">
              <h4>${claim.patientName}</h4>
              <p>${claim.date} - ${claim.encounter}</p>
            </div>
            <div class="claim-actions">
              <button class="view-btn" onclick="viewClaim(${claim.id})">View</button>
              <button class="delete-btn" onclick="deleteClaim(${claim.id})">Delete</button>
            </div>
          </div>
        `).join('');
      }
    }

    function viewClaim(claimId) {
      const savedClaims = JSON.parse(localStorage.getItem('savedClaims') || '[]');
      const claim = savedClaims.find(c => c.id === claimId);
      if (claim) {
        alert(`Claim: ${claim.patientName}\n\n${claim.claimText}`);
      }
    }

    function deleteClaim(claimId) {
      if (confirm('Are you sure you want to delete this claim?')) {
        const savedClaims = JSON.parse(localStorage.getItem('savedClaims') || '[]');
        const updatedClaims = savedClaims.filter(c => c.id !== claimId);
        localStorage.setItem('savedClaims', JSON.stringify(updatedClaims));
        loadSavedClaims();
      }
    }
  </script>
</body>
</html>